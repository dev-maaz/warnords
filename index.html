<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>

    <script>
    class Example extends Phaser.Scene {
        preload() {
    
            this.load.image('mech1', 'assets/AA First Mech.png');
            this.load.image('mech2', 'assets/Jupiter.png');
            this.load.image('mech3', 'assets/Scorpio.png');
            this.load.image('enemy', 'assets/Space Marines.png');

        }

        create() {

            this.LANE_COUNT = 5;
            this.LANE_HEIGHT = this.game.config.height / this.LANE_COUNT;
            this.currentLane = 0;
            this.currentLaneP2 = 0;

            this.selectorP1 = this.add.rectangle(
                this.game.config.width / 2 - this.game.config.width / 4,
                this.LANE_HEIGHT / 2,
                this.game.config.width /2,
                this.LANE_HEIGHT,
                0xFFFF00,
                0.3
            );

            this.selectorP2 = this.add.rectangle(
                this.game.config.width / 2 + this.game.config.width / 4,
                this.LANE_HEIGHT / 2,
                this.game.config.width /2,
                this.LANE_HEIGHT,
                0xFF0FF0,
                0.4
            );

            this.playerUnits = this.physics.add.group({
                runChildUpdate: true
            });

            this.P2Units = this.physics.add.group({
                runChildUpdate: true
            });

            this.keyW = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
            this.keyA = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
            this.keyS = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);
            this.keyD = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D);

            this.keyU = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.U);

            this.cursors = this.input.keyboard.createCursorKeys();
            this.spaceBar = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);

            this.input.keyboard.on('keydown-LEFT', this.selectPreviousUnit, this);
            this.input.keyboard.on('keydown-RIGHT', this.selectNextUnit, this);


            // this.input.keyboard.on('key_UP', this.moveSelectorP1Up, this);
            // this.input.keyboard.on('key_DOWN', this.moveSelectorP1Down, this);
            // this.spaceBar.on('down', this.spawnUnit, this);

            this.unitTypes = ['mech1', 'mech2', 'mech3'];
            this.currentUnitIndex = 0;

            this.selectCursor = this.add.rectangle(
                30,
                30,
                30,
                5,
                0xffffff,
                0.3
            )

            this.add.image(10, 30, this.unitTypes[0]);
            this.add.image(60, 30, this.unitTypes[1]);
            this.add.image(110, 30, this.unitTypes[2]);
            this.selectedUnitDisplay = this.add.image(10, 40, this.unitTypes[this.currentUnitIndex]);
            this.selectedUnitDisplay.setOrigin(0, 0);
            this.selectedUnitDisplay.setScale(0.75);
        }

        update() {

            this.playerUnits.children.entries.forEach((unit) => {
                unit.x += 3; 
                if (unit.x > this.game.config.width) {
                    unit.destroy();
                }
            });

            this.P2Units.children.entries.forEach((unit) => {
                unit.x -= 3; 
                if (unit.x > this.game.config.width) {
                    unit.destroy();
                }
            });

            if (Phaser.Input.Keyboard.JustDown(this.cursors.up)) {
                this.moveSelectorP1Up();
            } else if (Phaser.Input.Keyboard.JustDown(this.cursors.down)) {
                this.moveSelectorP1Down();
            }

            if (Phaser.Input.Keyboard.JustDown(this.spaceBar)) {
                this.spawnUnit();
            }

            if (Phaser.Input.Keyboard.JustDown(this.keyW)) {
                this.moveSelectorP2Up();
                console.log("w pressed");
            } else if (Phaser.Input.Keyboard.JustDown(this.keyS)) {
                this.moveSelectorP2Down();
            }

            if (Phaser.Input.Keyboard.JustDown(this.keyU)) {
                console.log("u")
                this.spawnUnitP2();
            }
        }

        // PLAYER 1 CONTROLS
        moveSelectorP1Up() {
            if (this.currentLane > 0) {
                this.currentLane--;
                this.updateSelectorP1Position();
            }
        }

        moveSelectorP1Down() {
            if (this.currentLane < this.LANE_COUNT - 1) {
                this.currentLane++;
                this.updateSelectorP1Position();
            }
        }

        updateSelectorP1Position() {
            this.selectorP1.y = this.currentLane * this.LANE_HEIGHT + this.LANE_HEIGHT / 2;
        }

        spawnUnit() {
            const unitY = this.currentLane * this.LANE_HEIGHT + this.LANE_HEIGHT / 2;
            const unit = this.physics.add.sprite(0, unitY, this.unitTypes[this.currentUnitIndex]);

            unit.setScale(1);
            unit.setOrigin(0, 0.5);
            
            unit.body.setAllowGravity(false);
            
            this.playerUnits.add(unit);
        }

        selectPreviousUnit() {
            this.currentUnitIndex = (this.currentUnitIndex - 1 + this.unitTypes.length) % this.unitTypes.length;
            if(this.selectCursor.x >= 60)this.selectCursor.x = this.selectCursor.x - 50;
            this.updateSelectedUnitDisplay();
        }

        selectNextUnit() {
            this.currentUnitIndex = (this.currentUnitIndex + 1) % this.unitTypes.length;
            if(this.selectCursor.x <= 60)this.selectCursor.x = this.selectCursor.x + 50;
            this.updateSelectedUnitDisplay();
        }

        updateSelectedUnitDisplay() {
            this.selectedUnitDisplay.setTexture(this.unitTypes[this.currentUnitIndex]);
        }

        //PLAYER 2 CONTROLS
        moveSelectorP2Up() {
            if (this.currentLaneP2 > 0) {
                this.currentLaneP2--;
                this.updateSelectorP2Position();
            }
        }

        moveSelectorP2Down() {
            if (this.currentLaneP2 < this.LANE_COUNT - 1) {
                this.currentLaneP2++;
                this.updateSelectorP2Position();
            }
        }

        updateSelectorP2Position() {
            this.selectorP2.y = this.currentLaneP2 * this.LANE_HEIGHT + this.LANE_HEIGHT / 2;
        }

        spawnUnitP2() {
            const unitY = this.currentLaneP2 * this.LANE_HEIGHT + this.LANE_HEIGHT / 2;
            const unit = this.physics.add.sprite(0, unitY, this.unitTypes[this.currentUnitIndex]);

            unit.setScale(1);
            unit.setOrigin(400, 0.5);
            
            unit.body.setAllowGravity(false);
            
            this.P2Units.add(unit);
        }

        // selectPreviousUnit() {
        //     this.currentUnitIndex = (this.currentUnitIndex - 1 + this.unitTypes.length) % this.unitTypes.length;
        //     if(this.selectCursor.x >= 60)this.selectCursor.x = this.selectCursor.x - 50;
        //     this.updateSelectedUnitDisplay();
        // }

        // selectNextUnit() {
        //     this.currentUnitIndex = (this.currentUnitIndex + 1) % this.unitTypes.length;
        //     if(this.selectCursor.x <= 60)this.selectCursor.x = this.selectCursor.x + 50;
        //     this.updateSelectedUnitDisplay();
        // }

        // updateSelectedUnitDisplay() {
        //     this.selectedUnitDisplay.setTexture(this.unitTypes[this.currentUnitIndex]);
        // }
    }

    const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        scene: Example,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 0 } 
            }
        }
    };

    const game = new Phaser.Game(config);
    </script>

</body>
</html>
